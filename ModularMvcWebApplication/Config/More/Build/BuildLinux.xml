<?xml version="1.0" encoding="UTF-8"?>
<project 
    name="{APPLICATION_NAMESPACE}" 
    default="Build"
    xmlns:if="ant:if"
    xmlns:unless="ant:unless"
>

    <property name="baseFolder" value="/var/www"/>
    <property name="phpFolder" value="/usr/bin"/>
    <property name="dblejFolder" value="${baseFolder}/vhosts/shared/DblEj"/>
    <property name="waflFolder" value="${baseFolder}/vhosts/shared/Wafl"/>
    <property name="webappFolder" value="${baseFolder}/vhosts/{APPLICATION_DOMAIN}"/>
    <property name="outputFolder" value="${webappFolder}/Output"/>
		
    <!-- if using jenkins -->
    <!-- property environment="env"/ -->
    <!-- property name="workspace" value="${env.WORKSPACE}" / -->
    <!-- property name="jobname" value="${env.JOB_NAME}" / -->
    <!-- property name="buildid" value="${env.BUILD_ID}" / -->

    <!-- if not using jenkins -->
    <property name="workspace" value="${outputFolder}/Build"/>
    <property name="jobname" value="Demo Modular Mvc Web App Windows Build" />
    <property name="buildid" value="Build1" />

    <property name="installFolder" value="${workspace}/AppRoot"/>


    <target name="AggregateBuildReports" description="Aggregate tool output with PHP_CodeBrowser">
        <exec executable="phpcb" dir="${phpFolder}">
            <arg value="--log" />
            <arg path="${outputFolder}/Build/Docs/Current/BuildLogs" />
            <arg value="--source" />
            <arg path="${installFolder}/{APPLICATION_NAMESPACE}" />
            <arg value="--output" />
            <arg path="${outputFolder}/Build/Docs/Current/CodeBrowser" />
        </exec>
    </target>
	
    <target name="Build"
            depends="PrepareBuild,CheckPhpSyntax,MeasureProjectSize,CalculatePhpCodeQuality,DetectPhpMesses,ValidatePhpCodingStandard,DetectDuplicatePhpCode,RunDatabaseUpdates,RunUnitTests,AggregateBuildReports"/>

    <target name="CalculatePhpCodeQuality" description="Calculate software metrics using PHP_Depend">
        <exec executable="pdepend" dir="${phpFolder}">
            <arg value="--jdepend-xml=${outputFolder}/Build/Docs/Current/BuildLogs/AppMetrics.xml" />
            <arg value="--jdepend-chart=${outputFolder}/Build/Docs/Current/BuildLogs/AppMetricsChart.svg" />
            <arg value="--overview-pyramid=${outputFolder}/Build/Docs/Current/BuildLogs/OverviewPyramidChart.svg" />
            <arg path="${installFolder}/{APPLICATION_NAMESPACE}" />
        </exec>
    </target>

    <target name="CheckPhpSyntax" depends="PrepareBuild" description="Perform syntax check of sourcecode files">
        <echo>Checking syntax for ${basedir} /App, /Public and, /Tests with php -l...</echo>
        <apply executable="php" failonerror="true">
            <arg value="-l" />
            <fileset dir="${installFolder}/{APPLICATION_NAMESPACE}">
                <include name="**/*.php" />
                <modified />
            </fileset>
            <fileset dir="${installFolder}/Public">
                <include name="**/*.php" />
                <modified />
            </fileset>
            <fileset dir="${installFolder}/{APPLICATION_NAMESPACE}/Tests">
                <include name="**/*.php" />
                <modified />
            </fileset>
        </apply>
    </target>

    <target name="Clean" description="Cleanup build artifacts">
        <echo message="Deleting workspace folders from previous build..."/>
        <delete dir="${outputFolder}/Build"/>
        <delete dir="${workspace}/shared"/>
    </target>

    <target name="DetectDuplicatePhpCode" description="Find duplicate code using phpcpd">
        <exec executable="phpcpd" dir="${phpFolder}">
            <arg value="--log-pmd" />
            <arg value="${outputFolder}/Build/Docs/Current/BuildLogs/DuplicateCodeReport.xml" />
            <arg path="${installFolder}/{APPLICATION_NAMESPACE}" />
        </exec>
    </target>

    <target name="DetectPhpMesses" description="Perform project mess detection using phpmd creating a log file for the continuous integration server">
        <exec executable="phpmd" dir="${phpFolder}">
            <arg path="${installFolder}/{APPLICATION_NAMESPACE}" />
            <arg value="xml" />
            <arg path="${waflFolder}/CodingStandards/Wafl1Md/ruleset.xml" />
            <arg value="--reportfile" />
            <arg path="${outputFolder}/Build/Docs/Current/BuildLogs/MessDetectionLog.xml" />
        </exec>
    </target>
	
    <target name="GeneratePhpDocumentation" description="Generate API documentation using phpDox">
        <exec executable="phpdoc" dir="${phpFolder}">
            <arg value="-f" />
            <arg value="${basedir}/phpdox.xml" />
        </exec>
    </target>

    <target name="GetRevisionFromMercurialRepo">
        <echo message="Getting the repo revision number for the App..."/>
        <exec dir="${workspace}/AppRoot" executable="hg" outputproperty="AppHgSummary">
            <arg line="summary"/>
        </exec>
        <echo>Got app hg summary ${AppHgSummary}</echo>
        <propertyregex property="AppRevision"
                       input="${AppHgSummary}"
                       regexp="parent: ([0-9]*):([a-z0-9]*) tip"
                       select="\1"
                       defaultValue="AppRevision"
                       casesensitive="false" />
        <echo>Got app revision ${AppRevision}</echo>
    </target>

    <target name="MeasureProjectSize" description="Measure project size using phploc">
        <echo>Running phploc to get project size...</echo>
        <exec executable="phploc" dir="${phpFolder}">
            <arg value="--log-csv" />
            <arg path="${outputFolder}/Build/Docs/Current/BuildLogs/ProjectSizeReport.csv" />
            <arg path="${installFolder}/{APPLICATION_NAMESPACE}" />
        </exec> 
    </target> 
	
    <target name="PrepareBuild" depends="Clean" description="Prepare for the build">
        <echo message="Creating workspace folders needed for build..."/>
        <mkdir dir="${outputFolder}/Build/Docs/Current/"/>
        <mkdir dir="${outputFolder}/Build/Docs/Current/BuildLogs"/>
        <mkdir dir="${outputFolder}/Build/Docs/Current/CoverageReportHtml"/>
        <mkdir dir="${installFolder}"/>
        <mkdir dir="${installFolder}/{APPLICATION_NAMESPACE}"/>
        <mkdir dir="${workspace}/shared"/>
        <mkdir dir="${waflFolder}"/>
        <mkdir dir="${dblejFolder}"/>
        <mkdir dir="${outputFolder}/Temp"/>
        <mkdir dir="${outputFolder}/Temp/Build"/>

        <echo message="Workspace: ${workspace}"/>

        <!-- if using jenkins -->
        <!--echo message="Job directory: ${workspace}../../jobs/${jobname}"/>
        <echo message="Build data: ${workspace}../../jobs/${jobname}/build/${buildid}"/-->


        <!-- if not using jenkins -->
        <copy todir="${installFolder}" >
            <fileset dir="${webappFolder}" includes="**.phar"/>
            <fileset dir="${webappFolder}" includes="**.syrp"/>
            <fileset dir="${webappFolder}" includes="**.md"/>
        </copy>
        <copy todir="${installFolder}/Public" >
            <fileset dir="${webappFolder}/Public" includes="**"/>
        </copy>
        <copy todir="${installFolder}/{APPLICATION_NAMESPACE}" >
            <fileset dir="${webappFolder}/{APPLICATION_NAMESPACE}" includes="**"/>
        </copy>
        <copy todir="${installFolder}/Config" >
            <fileset dir="${webappFolder}/Config" includes="**.syrp"/>
            <fileset dir="${webappFolder}/Config" includes="**.md"/>
        </copy>
        <copy todir="${installFolder}/Config/More" >
            <fileset dir="${webappFolder}/Config/More" includes="**.syrp"/>
            <fileset dir="${webappFolder}/Config/More" includes="**.md"/>
        </copy>
        <copy todir="${installFolder}/Config/More/Locale" >
            <fileset dir="${webappFolder}/Config/More/Locale" includes="**"/>
        </copy>
    </target>

    <target name="RunDatabaseUpdates" description="Run database updates">
        <exec dir="${waflFolder}/Bin" executable="php" failonerror="true">
            <env key="WAFL_ENVIRONMENT" value="build" />
            <arg line='DeployDatabaseChanges AppRoot="${installFolder}/" WaflEnvironment="build"' />
        </exec>
    </target>
	
    <target name="RunIntegrationTests" description="Run integration tests with PHPUnit">
        <echo message="Starting Xvfb..." />
        <exec dir="${waflFolder}/Extensions/Selenium" executable="Xvfb" spawn="true">
            <env key="DISPLAY" value=":10" />
            <arg line=':10 -ac' />
        </exec>
        <echo message="Waiting for Xvfb to finish starting..." />
        <sleep seconds="5"/>
        <echo message="Starting Selenium Server..." />
        <exec dir="${waflFolder}/Extensions/Selenium" executable="java" spawn="true">
            <env key="DISPLAY" value=":10" />
            <arg line='-jar selenium-server-standalone-2.40.0.jar' />
        </exec>
        <echo message="Waiting for Selenium Server to finish starting..." />
        <sleep seconds="5"/>
        <echo message="Starting phpunit..." />
        <exec dir="${phpFolder}" executable="phpunit" failonerror="true">
            <env key="WAFL_ENVIRONMENT" value="build" />
            <env key="DISPLAY" value=":10" />
            <arg line='--bootstrap="${installFolder}/Bootstrap.php"' />
            <arg path="./*" />
        </exec>
        <echo message="done" />
    </target>
	
    <target name="RunUnitTests" description="Run unit tests with PHPUnit">
        <apply executable="phpunit" dir="${phpFolder}" parallel="true">
            <env key="WAFL_ENVIRONMENT" value="build" />
            <arg line="--configuration" />
            <arg path="${webappFolder}/Config/More/Build/PhpUnit.xml" />
            <fileset dir="${installFolder}/{APPLICATION_NAMESPACE}/Tests/Unit" includes="*.php"/>
        </apply>
        <echo message="done" />
    </target>
	
    <target name="ValidatePhpCodingStandard" description="Find coding standard violations using PHP_CodeSniffer creating a log file for the continuous integration server">
        <exec executable="phpcs" dir="${phpFolder}">
            <arg value="-v" />
            <arg value="--report=checkstyle" />
            <arg value='--report-file="${outputFolder}/Build/Docs/Current/BuildLogs/CodeStandardViolations.xml"' />
            <arg value='--standard="${waflFolder}/CodingStandards/Wafl1/ruleset.xml"' />
            <arg path="${installFolder}/{APPLICATION_NAMESPACE}" />
        </exec>
    </target>	
    <target name="DeployToStagingServer" description="Deploy the website to staging">
        <delete dir="${baseFolder}/vhosts/s.myapp.tld/Config" failonerror="false" verbose="true" />
        <delete dir="${baseFolder}/vhosts/s.myapp.tld/{APPLICATION_NAMESPACE}" failonerror="false" verbose="true" />
        <delete dir="${baseFolder}/vhosts/s.myapp.tld/Public" failonerror="false" verbose="true" />
        <mkdir dir="${baseFolder}/vhosts/s.myapp.tld/Config"/>
        <mkdir dir="${baseFolder}/vhosts/s.myapp.tld/{APPLICATION_NAMESPACE}"/>
        <mkdir dir="${baseFolder}/vhosts/s.myapp.tld/Public"/>
				
        <echo message="Copying in new files..." />		
        <copy todir="${baseFolder}/vhosts/shared/Wafl" >  
            <fileset dir="${waflFolder}" includes="**"/>  
        </copy>
        <copy todir="${baseFolder}/vhosts/shared/DblEj" >  
            <fileset dir="${dblejFolder}" includes="**"/>  
        </copy>
		  
        <copy todir="${baseFolder}/vhosts/s.myapp.tld/Config" >  
            <fileset dir="${installFolder}/Config" includes="**"/>  
        </copy>
        <copy todir="${baseFolder}/vhosts/s.myapp.tld/Public" >  
            <fileset dir="${installFolder}/Public" includes="**"/>  
        </copy>
        <copy todir="${baseFolder}/vhosts/s.{APPLICATION_DOMAIN}/{APPLICATION_NAMESPACE}" >  
            <fileset dir="${installFolder}/{APPLICATION_NAMESPACE}" includes="**"/>  
        </copy>
        <copy file="${installFolder}/AppSupport.phar" tofile="${baseFolder}/vhosts/s.{APPLICATION_DOMAIN}/AppSupport.phar" />
        <copy file="${installFolder}/Application.syrp" tofile="${baseFolder}/vhosts/s.{APPLICATION_DOMAIN}/Application.syrp" />
        <copy file="${installFolder}/Readme.md" tofile="${baseFolder}/vhosts/s.{APPLICATION_DOMAIN}/Readme.md" />
				
        <echo message="Setting htaccess environment to 'stage'..." />		
        <replace file="${baseFolder}/vhosts/s.{APPLICATION_DOMAIN}/Public/.htaccess" token="SetEnv WAFL_ENVIRONMENT dev" value="SetEnv WAFL_ENVIRONMENT stage"/>		
    </target>
    <target name="DeployToTestServer" description="Deploy the website to test">
        <echo message="Clearing out old files..." />
        <delete dir="${baseFolder}/vhosts/{APPLICATION_DOMAIN}/Config" failonerror="false" verbose="true" />
        <delete dir="${baseFolder}/vhosts/{APPLICATION_DOMAIN}/{APPLICATION_NAMESPACE}" failonerror="false" verbose="true" />
        <delete dir="${baseFolder}/vhosts/{APPLICATION_DOMAIN}/Public" failonerror="false" verbose="true" />
        <mkdir dir="${baseFolder}/vhosts/{APPLICATION_DOMAIN}/Config"/>
        <mkdir dir="${baseFolder}/vhosts/{APPLICATION_DOMAIN}/{APPLICATION_NAMESPACE}"/>
        <mkdir dir="${baseFolder}/vhosts/{APPLICATION_DOMAIN}/Public"/>
		
        <echo message="Copying in new files..." />		
        <copy todir="${baseFolder}/vhosts/{APPLICATION_DOMAIN}/Config" >  
            <fileset dir="${installFolder}/Config" includes="**"/>  
        </copy>
        <copy todir="${baseFolder}/vhosts/{APPLICATION_DOMAIN}/Public" >  
            <fileset dir="${installFolder}/Public" includes="**"/>  
        </copy>
        <copy todir="${baseFolder}/vhosts/{APPLICATION_DOMAIN}/{APPLICATION_NAMESPACE}" >  
            <fileset dir="${installFolder}/{APPLICATION_NAMESPACE}" includes="**"/>  
        </copy>
        <copy todir="${baseFolder}/vhosts/{APPLICATION_DOMAIN}" >  
            <fileset dir="${installFolder}" includes="**.php"/>  
        </copy>
        <copy file="${installFolder}/AppSupport.phar" tofile="${baseFolder}/vhosts/{APPLICATION_DOMAIN}/AppSupport.phar" />
        <copy file="${installFolder}/Application.syrp" tofile="${baseFolder}/vhosts/{APPLICATION_DOMAIN}/Application.syrp" />
        <copy file="${installFolder}/Readme.md" tofile="${baseFolder}/vhosts/{APPLICATION_DOMAIN}/Readme.md" />
		
        <echo message="Setting htaccess environment to 'test'..." />		
        <replace file="${baseFolder}/vhosts/{APPLICATION_DOMAIN}/Public/.htaccess" token="SetEnv WAFL_ENVIRONMENT dev" value="SetEnv WAFL_ENVIRONMENT test"/>		
    </target>
    <target name="DeployToProductionServer" description="Deploy the website to live production">
        <echo message="Saving the version information to a sql database..." />		
        <sql
            classpath="C:/Program Files (x86)/MySQL/MySQL Connector J/mysql-connector-java-5.1.31.jar"
            driver="com.mysql.jdbc.Driver"
            url="jdbc:mysql://myapp-dbserver-address:3306/mysql"
            userid="myapp-dbuser"
            password="myapp-dbpassword"
            autocommit="true">
            use myapp-db
            update SomeTable set SomeField = '${MyAppRevision}';
        </sql>
		  
        <echo message="Copying in new files..." />		
        <copy todir="${webappFolder}/Config" >  
            <fileset dir="${installFolder}/Config" includes="**"/>  
        </copy>
        <copy todir="${webappFolder}/Public" >  
            <fileset dir="${installFolder}/Public" includes="**"/>  
        </copy>
        <copy todir="${webappFolder}/{APPLICATION_NAMESPACE}" >  
            <fileset dir="${installFolder}/{APPLICATION_NAMESPACE}" includes="**"/>  
        </copy>
        <copy file="${installFolder}/AppSupport.phar" tofile="${webappFolder}/AppSupport.phar" />
        <copy file="${installFolder}/Application.syrp" tofile="${webappFolder}/Application.syrp" />
        <copy file="${installFolder}/Readme.md" tofile="${webappFolder}/Readme.md" />
		
		
        <echo message="Setting htaccess environment to 'prod'..." />		
        <replace file="${webappFolder}/Public/.htaccess" token="SetEnv WAFL_ENVIRONMENT dev" value="SetEnv WAFL_ENVIRONMENT prod"/>
    </target>
	
</project>